name: Build single-file executable for Linux
on: [push, pull_request]
env:
  NODE_ENV: production
jobs:
  build:
    name: linux-${{ matrix.target }}-tasks-server
    runs-on: ubuntu-latest
    needs: test
    strategy:
      matrix:
        target: [x64, arm64]
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: Install bun
        uses: oven-sh/setup-bun@v2
      - name: Install dependencies
        run: sh install.sh
      - name: Initialize database
        run: |
          bun run init-db.ts
          ls -lh .database/tasks.db
          ls -lh .database/tasks-throttle.db
      - name: Compile
        run: |
          if [[ "${{ matrix.target }}" == "x64" ]]; then
            bun build --compile --minify --sourcemap src/main.ts --outfile ./tasks-server
          elif [[ "${{ matrix.target }}" == "arm64" ]]; then
            bun build --compile --target=bun-linux-arm64 --minify --sourcemap src/main.ts --outfile ./tasks-server-arm64
          fi
      - name: Verify output
        run: |
          if [[ "${{ matrix.target }}" == "x64" ]]; then
            ls -lh ./tasks-server
          elif [[ "${{ matrix.target }}" == "arm64" ]]; then
            ls -lh ./tasks-server-arm64
          fi
